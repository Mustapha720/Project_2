<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NEPA Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap"
        rel="stylesheet" />
    <style>
        :root {
            --warm-1: #ff7a59;
            --warm-2: #ffb199;
            --cool-1: #2ec4b6;
            --cool-2: #3a86ff;
            --bg: #f7fbfc;
            --card: #ffffff;
            --muted: #6b7280;
            --glass: rgba(255, 255, 255, 0.65);
            font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
        }

        /* Global reset tweaks */
        html,
        body {
            height: 100%;
            background: linear-gradient(135deg, var(--warm-2), var(--cool-1));
            margin: 0;
        }

        body {
            background-attachment: fixed;
            -webkit-font-smoothing: antialiased;
            color: #0f172a;
            font-size: 16px;
            -webkit-font-smoothing: antialiased;
        }

        .app-shell {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            max-width: 1200px;
            margin: 0 auto;
        }

        header.app-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            padding: 1rem 1.25rem;
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0.03));
            backdrop-filter: blur(6px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            flex-wrap: wrap;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: .75rem;
        }

        .brand h1 {
            font-size: 1.125rem;
            margin: 0;
            color: #fff;
            font-weight: 700;
            letter-spacing: 0.2px;
        }

        .brand .badge {
            background: rgba(255, 255, 255, 0.12);
            color: #fff;
            font-weight: 600;
            padding: .25rem .5rem;
            border-radius: 6px;
            font-size: 0.85rem;
        }

        #show {
            display: flex;
            align-items: center;
            gap: .75rem;
            color: #fff;
            min-width: 0;
        }

        #show .avatar {
            width: 44px;
            height: 44px;
            object-fit: cover;
            border-radius: 50%;
            box-shadow: 0 6px 18px rgba(10, 10, 20, 0.2);
            flex: 0 0 auto;
        }

        #show .profileText {
            display: flex;
            flex-direction: column;
            min-width: 0;
            overflow: hidden;
        }

        #show .profileText h4,
        #show .profileText span {
            margin: 0;
            color: var(--card);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .signout {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.18);
            color: #fff;
            padding: .45rem .6rem;
            border-radius: 8px;
            font-weight: 600;
        }

        main.container {
            flex: 1;
            display: grid;
            grid-template-columns: 360px 1fr;
            gap: 1.25rem;
            align-items: start;
            padding: 2rem 1.25rem;
            box-sizing: border-box;
        }

        /* Responsive: stack columns on small */
        @media (max-width: 1000px) {
            main.container {
                grid-template-columns: 1fr;
                padding: 1rem;
            }

            .brand h1 {
                font-size: 1rem;
            }

            header.app-header {
                padding: 0.75rem;
            }
        }

        @media (max-width: 480px) {
            .brand h1 {
                font-size: .95rem;
            }

            #show .avatar {
                width: 36px;
                height: 36px;
            }

            .signout {
                padding: .45rem .5rem;
                font-size: .9rem;
            }
        }

        .card-custom {
            background: var(--card);
            border-radius: 12px;
            padding: 1.25rem;
            box-shadow: 0 10px 30px rgba(12, 18, 30, 0.08);
        }

        .form-card .form-label {
            font-weight: 600;
            color: var(--muted);
            font-size: .9rem;
        }

        .form-control,
        .form-select {
            border-radius: 10px;
            padding: .8rem .9rem;
            border: 1px solid #e6eef3;
        }

        .btn-primary.custom {
            background: linear-gradient(90deg, var(--cool-1), var(--cool-2));
            border: none;
            color: #fff;
            padding: .7rem 1.1rem;
            border-radius: 10px;
            font-weight: 700;
            box-shadow: 0 8px 20px rgba(58, 134, 255, 0.18);
        }

        .muted {
            color: var(--muted);
            font-size: .9rem;
        }

        .list-card h3 {
            margin-top: 0;
            margin-bottom: .75rem;
        }

        #display {
            display: flex;
            flex-direction: column;
            gap: .6rem;
            max-height: 60vh;
            overflow: auto;
            padding-right: .25rem;
        }

        .entry {
            display: flex;
            gap: .75rem;
            align-items: center;
            padding: .65rem;
            border-radius: 10px;
            background: linear-gradient(180deg, rgba(46, 196, 182, 0.04), rgba(58, 134, 255, 0.02));
            border: 1px solid rgba(10, 10, 20, 0.03);
            justify-content: space-between;
        }

        .entry .left {
            display: flex;
            gap: .75rem;
            align-items: center;
            flex: 1;
            min-width: 0;
        }

        .entry .indexBox {
            width: 56px;
            height: 56px;
            border-radius: 12px;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            box-shadow: 0 8px 20px rgba(10, 10, 20, 0.06);
            flex-shrink: 0;
        }

        .entry .textWrap {
            min-width: 0;
        }

        .entry .area {
            font-weight: 700;
            color: #06202a;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .entry .meta {
            font-size: .85rem;
            color: #082032;
        }

        .entry .statusPill {
            padding: .45rem .7rem;
            border-radius: 999px;
            color: #fff;
            font-weight: 700;
            box-shadow: 0 6px 18px rgba(10, 10, 20, 0.06);
            white-space: nowrap;
        }

        /* Stack entry on small screens */
        @media (max-width: 640px) {
            #display {
                max-height: none;
            }

            .entry {
                flex-direction: column;
                align-items: stretch;
            }

            .entry .left {
                width: 100%;
            }

            .entry .statusPill {
                margin-top: .6rem;
                align-self: flex-start;
            }
        }

        /* make action buttons wrap on small screens */
        .actions {
            display: flex;
            gap: .75rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .small {
            font-size: .85rem;
        }

        .loading-gif {
            width: 44px;
            height: 44px;
            object-fit: cover;
            border-radius: 50%;
        }
    </style>
</head>

<body>
    <div class="app-shell">
        <header class="app-header">
            <div class="brand">
                <h1>NEPA Tracker</h1>
                <span class="badge small">Realtime</span>
            </div>

            <div style="display:flex; align-items:center; gap:1rem; min-width:0;">
                <div id="show" class="d-flex align-items-center">
                    <img class="loading-gif avatar"
                        src="https://www.superiorlawncareusa.com/wp-content/uploads/2020/05/loading-gif-png-5.gif"
                        alt="loading" />
                    <div class="profileText">
                        <h4 id="showName">Profile</h4>
                        <span id="showEmail" class="small">Not signed in</span>
                    </div>
                </div>

                <button onclick="userSignOut()" class="btn signout">Sign Out</button>
            </div>
        </header>

        <main class="container">
            <section class="card-custom form-card">
                <h2 style="margin-top:0; margin-bottom:.5rem">Report Light Status</h2>
                <p class="muted small">Quickly submit the current status for your area.</p>

                <div class="mb-3">
                    <label class="form-label">Your name</label>
                    <input type="text" placeholder="Input your name" id="user" class="form-control" />
                </div>

                <div class="mb-3">
                    <label class="form-label">Area</label>
                    <input type="text" placeholder="e.g. Ogbomoso" id="area" class="form-control" />
                </div>

                <div class="mb-4">
                    <label class="form-label">Light Status</label>
                    <select name="Status" id="status" title="Status" class="form-select">
                        <option value="" disabled selected>Light Status</option>
                        <option value="On">ON</option>
                        <option value="Off">OFF</option>
                    </select>
                </div>

                <div class="actions">
                    <button onclick="submit()" class="btn-primary custom">Submit</button>
                    <button type="button" class="btn btn-outline-secondary"
                        onclick="document.getElementById('area').value=''; document.getElementById('status').value=''; document.getElementById('user').value='';">Clear</button>
                </div>
            </section>

            <section class="card-custom list-card">
                <h3>Recent Reports</h3>
                <p class="small muted">Latest submissions will appear here in realtime.</p>
                <div id="display"></div>
            </section>
        </main>
    </div>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB6ZIuKAXssFOCSMJpxFYJlEVNEeCNrtIs",
            authDomain: "project-2-1e4b0.firebaseapp.com",
            databaseURL: "https://project-2-1e4b0-default-rtdb.firebaseio.com",
            projectId: "project-2-1e4b0",
            storageBucket: "project-2-1e4b0.firebasestorage.app",
            messagingSenderId: "266153523807",
            appId: "1:266153523807:web:e932044cb7e6f62abc39ea"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        let databaseList = 0;

        const showEl = document.getElementById('show');
        const showName = document.getElementById('showName');
        const showEmail = document.getElementById('showEmail');

        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log(user);
                // use safer display updates
                const avatarUrl = user.photoURL || 'https://www.superiorlawncareusa.com/wp-content/uploads/2020/05/loading-gif-png-5.gif';
                const name = user.displayName || 'User';
                const email = user.email || '';

                // update visible elements
                const imgEl = showEl.querySelector('.avatar');
                if (imgEl) imgEl.src = avatarUrl;
                showName.textContent = name;
                showEmail.textContent = email;
            } else {
                showName.textContent = 'Profile not found. Redirecting......';
                showEmail.textContent = '';
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1500);
            }
        });

        const submit = () => {
            const identity = document.getElementById('user').value.trim();
            const areaValue = document.getElementById('area').value.trim();
            const option = document.getElementById('status').value;
            if (!areaValue) {
                alert('Please input the area!');
                return;
            }
            if (!option) {
                alert('Select an option!');
                return;
            }
            if (!identity) {
                alert('Please input your name!');
                return;
            }

            const obj = {
                identity,
                area: areaValue,
                status: option,
                date: new Date().toLocaleDateString(),
                time: new Date().toLocaleTimeString()
            };

            // write to next numeric index
            const objRef = ref(database, `light_status/${databaseList}`);
            set(objRef, obj)
                .then(() => {
                    // clear inputs after success
                    document.getElementById('area').value = '';
                    document.getElementById('user').value = '';
                })
                .catch((err) => {
                    console.error('Write failed', err);
                    alert('Failed to submit. Try again.');
                });
        };

        const newRef = ref(database, 'light_status');
        onValue(newRef, (snapshot) => {
            const data = snapshot.val();
            console.log(data);

            // normalize to an array for safe iteration
            const entries = data ? (Array.isArray(data) ? data.filter(Boolean) : Object.values(data)) : [];
            databaseList = entries.length || 0;

            const displayEl = document.getElementById('display');
            displayEl.innerHTML = '';

            entries.forEach((info, idx) => {
                const status = (info && info.status) ? info.status : 'Unknown';
                const area = (info && info.area) ? info.area : '';
                const identity = (info && info.identity) ? info.identity : '';
                const date = (info && info.date) ? info.date : '';
                const time = (info && info.time) ? info.time : '';

                const accent = status.toLowerCase() === 'on' ? 'linear-gradient(135deg, var(--cool-1), var(--cool-2))' : 'linear-gradient(135deg, var(--warm-1), var(--warm-2))';
                const pillColor = status.toLowerCase() === 'on' ? 'var(--cool-1)' : 'var(--warm-1)';

                // build entry HTML using class names for responsive styling
                const entryHTML = `
                    <div class="entry" role="article" aria-label="Report ${idx + 1}">
                        <div class="left">
                            <div class="indexBox" style="background:${accent};">${idx + 1}</div>
                            <div class="textWrap">
                                <div class="area">${escapeHtml(area)}</div>
                                <div class="meta small">${escapeHtml(identity)} · ${escapeHtml(date)} ${escapeHtml(time)}</div>
                            </div>
                        </div>
                        <div style="margin-left:1rem; display:flex; align-items:center;">
                            <span class="statusPill" style="background:${pillColor};">${escapeHtml(status)}</span>
                        </div>
                    </div>
                `;
                displayEl.innerHTML += entryHTML;
            });
        });

        // simple escape to avoid html injection via firebase data
        function escapeHtml(str) {
            if (!str && str !== 0) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        const userSignOut = () => {
            signOut(auth)
                .then(() => {
                    console.log('User signed out!');
                    window.location.href = 'index.html';
                })
                .catch((error) => {
                    console.log(error);
                });
        };

        window.submit = submit;
        window.userSignOut = userSignOut;
    </script>
</body>

</html>