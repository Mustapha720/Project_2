<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEPA Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
</head>

<body>
    <button onclick="userSignOut()" class="btn btn-danger">Sign Out</button>
    <div id="show">
        <img src="https://www.superiorlawncareusa.com/wp-content/uploads/2020/05/loading-gif-png-5.gif" alt="" style="width: 50px;">
    </div>
    <input type="text" placeholder="Input your name" id="user">
    <input type="text" placeholder="Input your area (e.g Ogbomoso)" id="area">
    <select name="Status" id="status" title="Status" class="form-select">
        <option value="" disabled selected>Light Status</option>
        <option value="On">ON</option>
        <option value="Off">OFF</option>
    </select>
    <button onclick="submit()">Submit</button>
    <div id="display"></div>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB6ZIuKAXssFOCSMJpxFYJlEVNEeCNrtIs",
            authDomain: "project-2-1e4b0.firebaseapp.com",
            databaseURL: "https://project-2-1e4b0-default-rtdb.firebaseio.com",
            projectId: "project-2-1e4b0",
            storageBucket: "project-2-1e4b0.firebasestorage.app",
            messagingSenderId: "266153523807",
            appId: "1:266153523807:web:e932044cb7e6f62abc39ea"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        let databaseList = 0;


        onAuthStateChanged(auth, (user) => {
            if(user){
                console.log(user)
                show.innerHTML = ''
                show.innerHTML += `<img src='${user.photoURL}' style="border-radius: 100%"> <br> ${user.displayName} <br> ${user.email}`
            } else {
                show.innerHTML = '';
                show.innerHTML = `<h4>Profile not found. Redirecting......</h4>`;
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1500)
            }
        })


        const submit = () => {
            const user = document.getElementById('user').value;
            const areaValue = document.getElementById('area').value;
            const option = document.getElementById('status').value;
            console.log('user: ', user);
            console.log('area: ', areaValue);
            console.log('status: ', option);
            if (!areaValue) {
                alert('Please input the area!');
            } else if (option === '') {
                alert('Select an option!');
            } else if (!user) {
                alert('Please input your name!')
            } else {
                const obj = {
                    identity: user,
                    area: areaValue,
                    status: option,
                    date: new Date().toLocaleDateString(),
                    time: new Date().toLocaleTimeString()
                }
                console.log(obj);

                const objRef = ref(database, `light_status/${databaseList}`);
                set(objRef, obj)


                document.getElementById('area').value = '';
            }
        }

        const newRef = ref(database, 'light_status')
        onValue(newRef, (snapshot) => {
            const data = snapshot.val();
            console.log(data);
            if (data) {
                databaseList = data.length;
            } else {
                databaseList = 0;
            }

            document.getElementById('display').innerHTML = '';
            data.map((info, index) => {
                document.getElementById('display').innerHTML += `
                    <p>${index + 1}.</p> ${info.area} ${info.status} ${info.date} ${info.time} ${info.identity}
                `
            })
        })


        const userSignOut = () => {
            signOut(auth)
            .then(() => {
                console.log('User signed out!');
                window.location.href = 'index.html'
            })
            .catch((error) => {
                console.log(error);
            })
        }

        window.submit = submit
        window.userSignOut = userSignOut
    </script>
</body>

</html>